<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/adapter.coffee</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">src/</a> adapter.coffee
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">90.79% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>138/152</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">77.78% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>14/18</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">90.91% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>30/33</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">95.24% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>100/105</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">15×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">15×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">#
#    Copyright 2016 Jon Freedman
#
#    Licensed under the Apache License, Version 2.0 (the "License");
#    you may not use this file except in compliance with the License.
#    You may obtain a copy of the License at
#
#        http://www.apache.org/licenses/LICENSE-2.0
#
#    Unless required by applicable law or agreed to in writing, software
#    distributed under the License is distributed on an "AS IS" BASIS,
#    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#    See the License for the specific language governing permissions and
#    limitations under the License.
#
&nbsp;
{Adapter} = require 'hubot'
&nbsp;
Symphony = require './symphony'
{V2Message} = require './message'
memoize = require 'memoizee'
backoff = require 'backoff'
Entities = require('html-entities').XmlEntities
entities = new Entities()
&nbsp;
class SymphonyAdapter extends Adapter
&nbsp;
  constructor: (robot, @options = {}) -&gt;
    super(robot)
<span class="cstat-no" title="statement not covered" >    <span class="missing-if-branch" title="if path not taken" >I</span>throw new Error('HUBOT_SYMPHONY_HOST undefined')</span> unless process.env.HUBOT_SYMPHONY_HOST
<span class="cstat-no" title="statement not covered" >    <span class="missing-if-branch" title="if path not taken" >I</span>throw new Error('HUBOT_SYMPHONY_PUBLIC_KEY undefined')</span> unless process.env.HUBOT_SYMPHONY_PUBLIC_KEY
<span class="cstat-no" title="statement not covered" >    <span class="missing-if-branch" title="if path not taken" >I</span>throw new Error('HUBOT_SYMPHONY_PRIVATE_KEY undefined')</span> unless process.env.HUBOT_SYMPHONY_PRIVATE_KEY
    throw new Error('HUBOT_SYMPHONY_PASSPHRASE undefined') unless process.env.HUBOT_SYMPHONY_PASSPHRASE
&nbsp;
    @expBackoff = backoff.exponential(initialDelay: 10, maxDelay: 60000)
    @expBackoff.on 'backoff', (num, delay) =&gt;
      if num &gt; 0
        @robot.logger.info "Re-attempting to create datafeed - attempt #{num} after #{delay}ms"
    @expBackoff.on 'ready', () =&gt;
      @symphony.createDatafeed()
        .then (response) =&gt;
          <span class="missing-if-branch" title="else path not taken" >E</span>if response.id?
            @robot.logger.info "Created datafeed: #{response.id}"
            this.removeAllListeners 'poll'
            this.on 'poll', @_pollDatafeed
            @emit 'poll', response.id
            @robot.logger.debug "First 'poll' event emitted"
            @emit 'connected'
            @robot.logger.debug "'connected' event emitted"
            @expBackoff.reset()
          else
<span class="cstat-no" title="statement not covered" >            @robot.emit 'error', new Error(<span class="cstat-no" title="statement not covered" >"Unable to create datafeed: #{<span class="cstat-no" title="statement not covered" >response</span>}</span>")</span>
<span class="cstat-no" title="statement not covered" >            @expBackoff.backoff()</span>
        .fail (err) =&gt;
          @robot.emit 'error', new Error("Unable to create datafeed: #{err}")
          @expBackoff.backoff()
    @expBackoff.on 'fail', () =&gt;
      @robot.logger.info 'Shutting down...'
      @options.shutdownFunc()
    failAfter = @options.failConnectAfter ? 23 # will time out reconnecting after ~10min
    @robot.logger.info "Reconnect attempts = #{failAfter}"
    @expBackoff.failAfter(failAfter)
&nbsp;
  send: (envelope, messages...) -&gt;
    @robot.logger.debug "Send #{messages.length} messages to #{envelope.room}"
    for message in messages
      format = message.format ? 'TEXT'
      text = message.text ? message
      @symphony.sendMessage(envelope.room, text, format)
&nbsp;
  sendDirectMessageToUsername: (username, messages...) -&gt;
    @robot.logger.debug "Sending direct message to username: #{username}"
    @_userLookup({username: username})
      .then (response) =&gt;
        @_sendDirectMessageToUserId(response.id, messages...)
&nbsp;
  sendDirectMessageToEmail: (email, messages...) -&gt;
    @robot.logger.debug "Sending direct message to email: #{email}"
    @_userLookup({emailAddress: email})
      .then (response) =&gt;
        @_sendDirectMessageToUserId(response.id, messages...)
&nbsp;
  _sendDirectMessageToUserId: (userId, messages...) -&gt;
    @symphony.createIM(userId)
      .then (response) =&gt;
        @send({room: response.id}, messages...)
&nbsp;
  reply: (envelope, messages...) -&gt;
    @robot.logger.debug "Reply #{messages.length} messages to #{envelope.user.emailAddress} in #{envelope.room}"
    for message in messages
      @symphony.sendMessage(envelope.room, "&lt;messageML&gt;&lt;mention email=\"#{envelope.user.emailAddress}\"/&gt; #{entities.encode(message)}&lt;/messageML&gt;", 'MESSAGEML')
&nbsp;
  run: =&gt;
    @robot.logger.info "Initialising..."
    host = process.env.HUBOT_SYMPHONY_HOST
    privateKey = process.env.HUBOT_SYMPHONY_PRIVATE_KEY
    publicKey = process.env.HUBOT_SYMPHONY_PUBLIC_KEY
    passprhase = process.env.HUBOT_SYMPHONY_PASSPHRASE
    keyManagerHost = process.env.HUBOT_SYMPHONY_KM_HOST ? host
    sessionAuthHost = process.env.HUBOT_SYMPHONY_SESSIONAUTH_HOST ? host
    agentHost = process.env.HUBOT_SYMPHONY_AGENT_HOST ? host
    @symphony = new Symphony({host: host, privateKey: privateKey, publicKey: publicKey, passphrase: passprhase, keyManagerHost: keyManagerHost, sessionAuthHost: sessionAuthHost, agentHost: agentHost})
    @symphony.whoAmI()
      .then (response) =&gt;
        @robot.userId = response.userId
        @symphony.getUser({userId: response.userId})
        .then (response) =&gt;
          @robot.displayName = response.displayName
          @robot.logger.info "Connected as #{response.displayName}"
      .fail <span class="fstat-no" title="function not covered" >(err) =&gt;</span>
<span class="cstat-no" title="statement not covered" >        @robot.emit 'error', new Error(<span class="cstat-no" title="statement not covered" >"Unable to resolve identity: #{<span class="cstat-no" title="statement not covered" >err</span>}</span>")</span>
    hourlyRefresh = memoize @_getUser, {maxAge: 3600000, length: 2}
    @_userLookup = (query, streamId) -&gt; hourlyRefresh query, streamId
    @_createDatafeed()
    return
&nbsp;
  close: =&gt;
    @robot.logger.debug 'Removing datafeed poller'
    this.removeListener 'poll', @_pollDatafeed
&nbsp;
  _createDatafeed: =&gt;
    @expBackoff.backoff()
&nbsp;
  _pollDatafeed: (id) =&gt;
    # defer execution to ensure we don't go into an infinite polling loop
    process.nextTick =&gt;
      @robot.logger.debug "Polling datafeed #{id}"
      @symphony.readDatafeed(id)
        .then (response) =&gt;
          if response?
            @robot.logger.debug "Received #{response.length ? 0} datafeed messages"
            @_receiveMessage msg for msg in response when msg.v2messageType is 'V2Message'
          @emit 'poll', id
        .fail (err) =&gt;
          @robot.emit 'error', new Error("Unable to read datafeed #{id}: #{err}")
          @_createDatafeed()
&nbsp;
  _receiveMessage: (message) =&gt;
    if message.fromUserId != @robot.userId
      @_userLookup({userId: message.fromUserId}, message.streamId)
        .then (response) =&gt;
          v2 = new V2Message(response, message)
          @robot.logger.debug "Received '#{v2.text}' from #{v2.user.name}"
          @receive v2
        .fail <span class="fstat-no" title="function not covered" >(err) =&gt;</span>
<span class="cstat-no" title="statement not covered" >          @robot.emit 'error', new Error(<span class="cstat-no" title="statement not covered" >"Unable to fetch user details: #{<span class="cstat-no" title="statement not covered" >err</span>}</span>")</span>
&nbsp;
  _getUser: (query, streamId) =&gt;
    @symphony.getUser(query)
      .then (response) =&gt;
        # record basic user details in hubot's brain, setting the room causes the brain to update each time we're seen in a new conversation
        userId = response.id
        existing = @robot.brain.userForId(userId)
        existing['name'] = response.username
        existing['displayName'] = response.displayName
        existing['emailAddress'] = response.emailAddress
        if streamId?
          existing['room'] = streamId
        @robot.brain.userForId(userId, existing)
        existing
&nbsp;
exports.use = (robot, options = {}) -&gt;
  options.shutdownFunc = options.shutdownFunc ? <span class="fstat-no" title="function not covered" >()</span> -&gt;
<span class="cstat-no" title="statement not covered" >    process.exit 1</span>
  new SymphonyAdapter robot, options
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Sun Feb 19 2017 16:18:09 GMT+0000 (UTC)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
